name: Weekly Dependency Upgrade

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.4'

jobs:
  upgrade-and-test:
    name: Upgrade Dependencies & Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      composer_changes: ${{ steps.check_changes.outputs.composer_changes }}
      npm_changes: ${{ steps.check_changes.outputs.npm_changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, libxml, openssl, pcre, phar, tokenizer, zip
          coverage: none

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Configure npm registry for GitHub Packages
        run: |
          # Configure in both home and project directory for bun compatibility
          echo "@hardimpactdev:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_PAT }}" >> ~/.npmrc
          # Also add to project .npmrc for bun
          echo "@hardimpactdev:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_PAT }}" >> .npmrc

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install current Composer dependencies
        env:
          COMPOSER_AUTH: '{"github-oauth": {"github.com": "${{ secrets.GH_PAT }}"}}'
        run: composer install --no-interaction --prefer-dist

      - name: Upgrade Composer dependencies to latest versions
        id: composer_upgrade
        env:
          COMPOSER_AUTH: '{"github-oauth": {"github.com": "${{ secrets.GH_PAT }}"}}'
        run: |
          echo "Checking for available Composer upgrades..."
          echo "### Composer Dependency Upgrades" >> $GITHUB_STEP_SUMMARY

          # Get outdated direct dependencies
          OUTDATED=$(composer outdated --direct --format=json 2>/dev/null | jq -r '.installed[] | select(.latest != null and .version != .latest) | "\(.name):\(.latest)"' || true)

          if [ -n "$OUTDATED" ]; then
            echo "Found outdated packages to upgrade:"
            echo "$OUTDATED"
            echo ""

            for pkg in $OUTDATED; do
              PACKAGE_NAME=$(echo "$pkg" | cut -d: -f1)
              LATEST_VERSION=$(echo "$pkg" | cut -d: -f2)

              # Check if it's a dev dependency
              if grep -A100 '"require-dev"' composer.json | grep -q "\"$PACKAGE_NAME\""; then
                echo "Upgrading dev dependency $PACKAGE_NAME to ^$LATEST_VERSION..."
                echo "- \`$PACKAGE_NAME\` → \`^$LATEST_VERSION\` (dev)" >> $GITHUB_STEP_SUMMARY
                composer require --dev "$PACKAGE_NAME:^$LATEST_VERSION" --no-interaction --no-update || true
              else
                echo "Upgrading $PACKAGE_NAME to ^$LATEST_VERSION..."
                echo "- \`$PACKAGE_NAME\` → \`^$LATEST_VERSION\`" >> $GITHUB_STEP_SUMMARY
                composer require "$PACKAGE_NAME:^$LATEST_VERSION" --no-interaction --no-update || true
              fi
            done

            # Run the actual update
            echo ""
            echo "Running composer update..."
            composer update --no-interaction --prefer-dist --with-all-dependencies
          else
            echo "No Composer upgrades available."
            echo "_No Composer upgrades available_" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upgrade npm dependencies to latest versions
        id: npm_upgrade
        run: |
          echo "Checking for available npm upgrades..."
          echo "### npm Dependency Upgrades" >> $GITHUB_STEP_SUMMARY

          # Install npm-check-updates
          bun add -g npm-check-updates

          # Check what would be upgraded
          echo "Available upgrades:"
          bunx ncu || true

          # Upgrade all dependencies in package.json to latest versions
          echo ""
          echo "Upgrading package.json to latest versions..."
          bunx ncu -u

          # Show what changed
          if ! git diff --quiet package.json; then
            echo "package.json was modified with new versions"
            echo "#### Upgraded packages:" >> $GITHUB_STEP_SUMMARY
            git diff package.json | grep "^[+-]" | grep -v "^[+-][+-]" >> $GITHUB_STEP_SUMMARY || true
          else
            echo "No npm upgrades available"
            echo "_No npm upgrades available_" >> $GITHUB_STEP_SUMMARY
          fi

          # Install upgraded dependencies
          echo ""
          echo "Installing upgraded dependencies..."
          bun install

      - name: Setup environment
        run: |
          cp .env.example .env
          php artisan key:generate
          touch database/database.sqlite

      - name: Run migrations
        run: php artisan migrate --force

      - name: Test setup command - App (Auth + Dashboard)
        run: |
          echo "Testing liftoff:setup app..."
          php artisan liftoff:setup app

          echo "Verifying Auth files..."
          test -f app/Http/Controllers/Auth/LoginController.php
          test -f app/Http/Controllers/Auth/RegisterController.php
          test -f resources/js/pages/auth/Login.vue

          echo "Verifying Dashboard files..."
          test -f app/Http/Controllers/DashboardController.php
          test -f resources/js/pages/Dashboard.vue

          echo "Setup app completed successfully!"

      - name: Test setup command - CMS
        run: |
          echo "Testing liftoff:setup cms..."
          php artisan liftoff:setup cms || echo "CMS setup may require additional dependencies"

          echo "Setup cms test completed!"

      - name: Build frontend assets
        run: bun run build

      - name: Install Playwright
        run: bunx playwright install chromium --with-deps

      - name: Start server and run tests
        run: |
          php artisan serve --host=127.0.0.1 --port=8000 &
          SERVER_PID=$!
          sleep 3

          # Test homepage
          echo "Testing homepage..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Homepage returned HTTP $HTTP_CODE - Success!"
          else
            echo "Homepage returned HTTP $HTTP_CODE - Expected 200"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          # Run Playwright tests
          bunx playwright test || true

          kill $SERVER_PID 2>/dev/null || true
        env:
          APP_URL: http://127.0.0.1:8000

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse || true

      - name: Run Pest tests
        run: vendor/bin/pest --ci || true

      - name: Check for changes
        id: check_changes
        run: |
          COMPOSER_CHANGED="false"
          NPM_CHANGED="false"

          if ! git diff --quiet composer.json composer.lock 2>/dev/null; then
            COMPOSER_CHANGED="true"
            echo "Composer changes detected"
          fi

          if ! git diff --quiet package.json bun.lockb 2>/dev/null; then
            NPM_CHANGED="true"
            echo "npm changes detected"
          fi

          if [ "$COMPOSER_CHANGED" = "true" ] || [ "$NPM_CHANGED" = "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          echo "composer_changes=$COMPOSER_CHANGED" >> $GITHUB_OUTPUT
          echo "npm_changes=$NPM_CHANGED" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Build commit message
          COMMIT_MSG="chore(deps): weekly dependency upgrade ($(date +%Y-%m-%d))"
          COMMIT_BODY=""

          if [ "${{ steps.check_changes.outputs.composer_changes }}" = "true" ]; then
            COMMIT_BODY="${COMMIT_BODY}\n- Composer dependencies upgraded to latest versions"
            git add composer.json composer.lock
          fi

          if [ "${{ steps.check_changes.outputs.npm_changes }}" = "true" ]; then
            COMMIT_BODY="${COMMIT_BODY}\n- npm dependencies upgraded to latest versions"
            git add package.json bun.lockb
          fi

          git commit -m "$COMMIT_MSG

          Automated weekly upgrade including major version upgrades where compatible.

          Changes:$(echo -e "$COMMIT_BODY")

          All tests passed:
          - Setup commands (app, cms)
          - Frontend build
          - Homepage rendering
          - Playwright tests

          Updated on: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          git push origin main

  notify-success:
    name: Notify Success (Slack)
    needs: [upgrade-and-test]
    if: |
      always() &&
      needs.upgrade-and-test.result == 'success' &&
      needs.upgrade-and-test.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Starterkit Dependencies Upgraded",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Repository:* `liftoff-starterkit`"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Tests Passed:*\n- Setup commands (app, cms)\n- Frontend build\n- Homepage rendering\n- Playwright tests"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commits"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/commits/main"
                    }
                  ]
                }
              ]
            }

  notify-failure:
    name: Notify Failure (Slack)
    needs: [upgrade-and-test]
    if: |
      always() &&
      needs.upgrade-and-test.result == 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Dependency Upgrade Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Repository:* `liftoff-starterkit`"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The weekly dependency upgrade failed during testing. Please review the workflow logs to identify which upgrade caused the issue."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Logs"
                      },
                      "style": "danger",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Checkout for gh CLI
        uses: actions/checkout@v4

      - name: Create failure issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh issue create \
            --title "Weekly dependency upgrade failed ($(date +%Y-%m-%d))" \
            --body "## Dependency Upgrade Failure

          The weekly dependency upgrade workflow failed during integration testing.

          ### Details
          - **Workflow run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### Next steps
          1. Review the workflow logs linked above
          2. Identify which dependency upgrade caused the failure
          3. Either fix the compatibility issue or pin the problematic dependency version

          ---
          *This issue was automatically created by the weekly dependency upgrade workflow.*" \
            --label "bug,dependencies"

  notify-no-updates:
    name: Notify No Updates (Slack)
    needs: [upgrade-and-test]
    if: |
      always() &&
      needs.upgrade-and-test.result == 'success' &&
      needs.upgrade-and-test.outputs.has_changes == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*liftoff-starterkit*: No dependency upgrades available this week. All packages are at their latest versions."
                  }
                }
              ]
            }
